---
import BaseLayout from "../../layouts/BaseLayout.astro";
import NavBar from "../../components/NavBar.astro";
---

<BaseLayout title="Nestey AI — Chat Demo">
  <NavBar />
  <div class="chat-container">
    <!-- Sidebar -->
    <aside class="chat-sidebar">
      <div class="sidebar-header">
        <button class="new-chat-btn">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M12 5v14M5 12h14"></path>
          </svg>
          New chat
        </button>
      </div>

      <div class="chat-history">
        <div class="history-section">
          <div class="history-label">Today</div>
          <button class="history-item active">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
              ></path>
            </svg>
            Employee onboarding questions
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="chat-main">
      <div class="chat-header">
        <h1>Nestey AI</h1>
        <span class="model-badge">HR Assistant</span>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="welcome-screen">
          <div class="nestey-logo">
            <img
              src="/icons/MasterNesteyHeroBlueWhite 300x300.png"
              alt="Nestey"
              width="108"
              height="108"
            />
          </div>
          <h2>Ask me anything.</h2>
          <div class="suggestion-grid">
            <button
              class="suggestion-card"
              data-prompt="What's my PTO balance?"
            >
              <div class="suggestion-text">PTO Balance</div>
            </button>
            <button class="suggestion-card" data-prompt="Show me my benefits">
              <div class="suggestion-text">My Benefits</div>
            </button>
            <button class="suggestion-card" data-prompt="What are my goals?">
              <div class="suggestion-text">My Goals</div>
            </button>
            <button class="suggestion-card" data-prompt="Who is my manager?">
              <div class="suggestion-text">My Manager</div>
            </button>
          </div>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <textarea
            id="chatInput"
            class="chat-input"
            placeholder="Ask me anything..."
            rows="1"></textarea>
          <button id="sendBtn" class="send-btn" disabled>
            <img
              src="/icons/EnterChatIcon.png"
              alt="Send"
              width="40"
              height="40"
              style="filter: brightness(0.35);"
            />
          </button>
        </div>
        <div class="chat-disclaimer">
          Nestey AI can make mistakes. Consider checking important information.
        </div>
      </div>
    </main>
  </div>
</BaseLayout>

<style>
  :global(body) {
    overflow: hidden;
  }

  .chat-container {
    display: flex;
    height: calc(100vh - 70px);
    background: var(--brand-background);
  }

  /* ============ SIDEBAR ============ */
  .chat-sidebar {
    width: 260px;
    background: #f0f0f0;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #e0e0e0;
  }

  .sidebar-header {
    padding: 1rem;
  }

  .new-chat-btn {
    width: 100%;
    padding: 0.75rem 1rem;
    background: white;
    border: 1px solid #d0d0d0;
    color: #333;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.2s;
  }

  .new-chat-btn:hover {
    background: #fafafa;
  }

  .chat-history {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
  }

  .history-section {
    margin-bottom: 1.5rem;
  }

  .history-label {
    color: #666;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    padding: 0.5rem 0.75rem;
    letter-spacing: 0.5px;
  }

  .history-item {
    width: 100%;
    padding: 0.75rem;
    background: transparent;
    border: none;
    color: #333;
    text-align: left;
    border-radius: var(--radius-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9rem;
    transition: background 0.2s;
    margin-bottom: 0.25rem;
  }

  .history-item:hover {
    background: rgba(0, 0, 0, 0.05);
    color: #333;
  }

  .history-item.active {
    background: rgba(0, 0, 0, 0.08);
    color: #333;
  }

  .sidebar-footer {
    padding: 1rem;
    border-top: 1px solid #e0e0e0;
  }

  .user-menu {
    width: 100%;
    padding: 0.75rem;
    background: transparent;
    border: 1px solid #d0d0d0;
    color: #333;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    transition: background 0.2s;
  }

  .user-menu:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  .user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--brand-blue-accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
  }

  /* ============ MAIN CHAT ============ */
  .chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
  }

  .chat-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--brand-border);
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .chat-header h1 {
    font-size: 1.25rem;
    color: var(--brand-blue);
    margin: 0;
  }

  .model-badge {
    padding: 0.25rem 0.75rem;
    background: var(--brand-accent-superlight);
    color: var(--brand-blue);
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
  }

  /* ============ WELCOME SCREEN ============ */
  .welcome-screen {
    max-width: 800px;
    margin: auto;
    text-align: center;
  }

  .nestey-logo {
    width: 108px;
    height: 108px;
    margin: 0 auto 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .nestey-logo img {
    display: block;
  }

  .welcome-screen h2 {
    font-size: 2rem;
    color: var(--brand-blue);
    margin-bottom: 2rem;
  }

  .suggestion-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-top: 2rem;
  }

  .suggestion-card {
    padding: 1.5rem;
    background: var(--brand-background);
    border: 1px solid var(--brand-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
  }

  .suggestion-card:hover {
    background: white;
    border-color: var(--brand-blue-accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .suggestion-icon {
    font-size: 1.5rem;
  }

  .suggestion-text {
    color: var(--text-dark);
    font-weight: 500;
    font-size: 0.95rem;
  }

  /* ============ MESSAGE BUBBLES ============ */
  .chat-messages .message {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    animation: fadeIn 0.25s ease;
    max-width: 70%;
    clear: both;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Assistant LEFT */
  .chat-messages .message.assistant {
    float: left;
    flex-direction: row;
  }

  /* User RIGHT */
  .chat-messages .message.user {
    float: right;
    flex-direction: row-reverse;
  }

  /* Avatar */
  .message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .message.user .message-avatar {
    background: var(--brand-blue-accent);
    color: white;
  }

  .message.assistant .message-avatar {
    background: var(--brand-blue);
    color: white;
  }

  /* Container for text */
  .message-content {
    min-width: 0;
  }

  /* Bubble styling */
  .message-text {
    padding: 1rem 1.25rem;
    border-radius: var(--radius-md);
    line-height: 1.55;
    word-wrap: break-word;
  }

  /* User bubble */
  .message.user .message-text {
    background: var(--brand-blue-accent) !important;
    color: white !important;
  }

  /* Assistant bubble */
  .message.assistant .message-text {
    background: var(--brand-background) !important;
    color: var(--text-dark) !important;
  }

  /* User RIGHT - FORCE IT */
  .message.user {
    margin-left: auto !important;
    margin-right: 0 !important;
    flex-direction: row-reverse !important;
  }

  /* Assistant LEFT - FORCE IT */
  .message.assistant {
    margin-right: auto !important;
    margin-left: 0 !important;
    flex-direction: row !important;
  }

  /* ============ INPUT AREA ============ */
  .chat-input-container {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--brand-border);
    background: white;
  }

  .chat-input-wrapper {
    max-width: 800px;
    margin: 0 auto;
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--brand-background);
    border: 1px solid var(--brand-border);
    border-radius: var(--radius-md);
    padding: 0.75rem 1rem;
    transition: border-color 0.2s;
  }

  .chat-input-wrapper:focus-within {
    border-color: var(--brand-blue-accent);
    box-shadow: 0 0 0 3px rgba(58, 122, 254, 0.1);
  }

  .chat-input {
    flex: 1;
    border: none;
    background: transparent;
    resize: none;
    outline: none;
    font-size: 1rem;
    font-family: inherit;
    line-height: 1.5;
    max-height: 200px;
    color: var(--text-dark);
  }

  .chat-input::placeholder {
    color: var(--text-medium);
  }

  .send-btn {
    width: 40px;
    height: 40px;
    background: transparent;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .send-btn:not(:disabled):hover {
    transform: scale(1.05);
  }

  .chat-disclaimer {
    text-align: center;
    font-size: 0.75rem;
    color: var(--text-medium);
    margin-top: 0.75rem;
  }

  /* ============ RESPONSIVE ============ */
  @media (max-width: 768px) {
    .chat-sidebar {
      position: absolute;
      left: -260px;
      height: 100%;
      z-index: 1000;
      transition: left 0.3s;
    }

    .chat-sidebar.open {
      left: 0;
    }

    .suggestion-grid {
      grid-template-columns: 1fr;
    }

    .welcome-screen h2 {
      font-size: 1.5rem;
    }
  }
</style>

<script>
  const chatInput = document.getElementById("chatInput") as HTMLTextAreaElement;
  const sendBtn = document.getElementById("sendBtn") as HTMLButtonElement;
  const chatMessages = document.getElementById(
    "chatMessages"
  ) as HTMLDivElement;
  const suggestionCards = document.querySelectorAll(".suggestion-card");

  // Load employee data from JSON
  let employeeData: any = null;

  async function loadEmployeeData() {
    try {
      const response = await fetch("/data/demo.json");
      employeeData = await response.json();
      console.log("Employee data loaded:", employeeData);
    } catch (error) {
      console.error("Failed to load employee data:", error);
    }
  }

  // Load data on page load
  loadEmployeeData();

  // Auto-resize textarea
  chatInput.addEventListener("input", () => {
    chatInput.style.height = "auto";
    chatInput.style.height = chatInput.scrollHeight + "px";
    sendBtn.disabled = chatInput.value.trim().length === 0;
  });

  // Handle send message
  function sendMessage(message: string) {
    if (!message.trim()) return;

    // Remove welcome screen if present
    const welcomeScreen = chatMessages.querySelector(".welcome-screen");
    if (welcomeScreen) {
      welcomeScreen.remove();
    }

    // Add user message
    const userMsg = document.createElement("div");
    userMsg.className = "message user";
    userMsg.style.cssText =
      "float: right !important; max-width: 70%; clear: both;";
    userMsg.innerHTML = `
      <div class="message-avatar" style="background: #3A7AFE; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">Me</div>
      <div class="message-content">
        <div class="message-text" style="background: #3A7AFE !important; color: white !important; padding: 0.65rem 1rem; border-radius: 18px; margin-top: 0.5rem;">${escapeHtml(message)}</div>
      </div>
    `;
    chatMessages.appendChild(userMsg);

    // Clear input
    chatInput.value = "";
    chatInput.style.height = "auto";
    sendBtn.disabled = true;

    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Simulate AI response
    setTimeout(() => {
      const assistantMsg = document.createElement("div");
      assistantMsg.className = "message assistant";
      assistantMsg.style.cssText =
        "float: left !important; max-width: 70%; clear: both;";
      assistantMsg.innerHTML = `
        <div class="message-avatar" style="width: 44px; height: 44px; min-width: 44px; min-height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 0; flex-shrink: 0;">
          <img src="/icons/nesteyAvatar_144x144.png" alt="Nestey" style="width: 100%; height: 100%; object-fit: cover;" />
        </div>
        <div class="message-content">
          <div class="message-text">${getAIResponse(message)}</div>
        </div>
      `;
      chatMessages.appendChild(assistantMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 1000);
  }

  // Send button click
  sendBtn.addEventListener("click", () => {
    sendMessage(chatInput.value);
  });

  // Enter to send (Shift+Enter for new line)
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage(chatInput.value);
    }
  });

  // Suggestion cards
  suggestionCards.forEach((card) => {
    card.addEventListener("click", () => {
      const prompt = (card as HTMLElement).dataset.prompt;
      if (prompt) {
        sendMessage(prompt);
      }
    });
  });

  // Escape HTML
  function escapeHtml(text: string): string {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  // Simple AI response generator
  function getAIResponse(question: string): string {
    const q = question.toLowerCase();

    // If no data loaded yet
    if (!employeeData) {
      return `Loading your employee data... Please try again in a moment.`;
    }

    const employee = employeeData.employee;
    const timeOff = employeeData.time_off;
    const benefits = employeeData.benefits;
    const goals = employeeData.goals;
    const review = employeeData.review;

    // Personal info questions
    if (
      q.includes("who am i") ||
      q.includes("my name") ||
      q.includes("my info") ||
      q.includes("job title") ||
      q.includes("my title") ||
      q.includes("what do i do") ||
      q.includes("my role")
    ) {
      return `You are <strong>${employee.full_name}</strong><br><br>
        <strong>Job Title:</strong> ${employee.job_title}<br>
        <strong>Department:</strong> ${employee.department}<br>
        <strong>Manager:</strong> ${employee.manager.manager_name} (${employee.manager.manager_title})<br>
        <strong>Email:</strong> ${employee.email}<br>
        <strong>Employee ID:</strong> ${employee.employee_number}<br>
        <strong>Hire Date:</strong> ${new Date(employee.hire_date).toLocaleDateString()}<br><br>
        What else would you like to know?`;
    }

    // Manager questions (but not about goals)
    if ((q.includes("who is my manager") || q.includes("my manager")) && !q.includes("goal")) {
      return `Your manager is <strong>${employee.manager.manager_name}</strong><br><br>
        <strong>Title:</strong> ${employee.manager.manager_title}<br><br>
        You can reach them through the Nestey messaging system or via email.`;
    }

    // Salary/compensation questions
    if (
      q.includes("salary") ||
      q.includes("compensation") ||
      q.includes("pay")
    ) {
      return `<strong>Your Compensation Details:</strong><br><br>
        <strong>Base Salary:</strong> $${employee.base_salary.toLocaleString()}/year<br>
        <strong>Target Bonus:</strong> ${employee.target_bonus_percent}%<br>
        <strong>Bonus Eligible:</strong> ${employee.bonus_eligible ? "Yes" : "No"}<br>
        <strong>Commission Eligible:</strong> ${employee.commission_eligible ? "Yes" : "No"}<br>
        <strong>Hours Per Week:</strong> ${employee.hours_per_week}<br><br>
        For payroll questions, contact payroll@company.com`;
    }

    // Time off questions
    if (
      q.includes("time off") ||
      q.includes("vacation") ||
      q.includes("pto") ||
      q.includes("balance")
    ) {
      return `<strong>Your Time Off Balances:</strong><br><br>
        <strong>PTO Balance:</strong> ${timeOff.pto_balance} days<br>
        <strong>Sick Leave:</strong> ${timeOff.sick_balance} days<br><br>
        <strong>2025 Accruals:</strong><br>
        ${timeOff.accruals.map((a: any) => `• ${a.type}: ${a.accrued} days accrued, ${a.used} used, ${a.remaining} remaining`).join("<br>")}<br><br>
        To request time off, click the "Time Off" section in your dashboard or just tell me the dates you need!`;
    }

    // Benefits questions
    if (
      q.includes("benefit") ||
      q.includes("insurance") ||
      q.includes("medical") ||
      q.includes("dental") ||
      q.includes("vision")
    ) {
      const benefitsList = benefits
        .map(
          (b: any) =>
            `<strong>${b.type}:</strong> ${b.plan_name}<br>
        Coverage: ${b.coverage_level} | You pay: $${b.employee_pays}/mo | Employer pays: $${b.employer_pays}/mo | Dependents: ${b.dependents}`
        )
        .join("<br><br>");

      return `<strong>Your Current Benefits:</strong><br><br>${benefitsList}<br><br>
        Total monthly cost to you: $${benefits.reduce((sum: number, b: any) => sum + b.employee_pays, 0)}<br><br>
        Need to make changes? Contact benefits@company.com or wait for open enrollment in November.`;
    }

    // Goals questions
    if (q.includes("goal") || q.includes("objective")) {
      // Check if asking about manager's goals
      if (
        q.includes("manager") ||
        q.includes("boss") ||
        q.includes("amanda") ||
        q.includes("ceo")
      ) {
        const managerGoals = employeeData.manager_goals;
        const managerGoalsList = managerGoals
          .map(
            (g: any, i: number) =>
              `<strong>${i + 1}. ${g.objective}</strong><br>
          ${g.description}<br>
          Strategy: ${g.strategy} (${g.strategy_description}) | Status: ${g.status} | Due: ${new Date(g.target_date).toLocaleDateString()}`
          )
          .join("<br><br>");

        return `<strong>${employee.manager.manager_name}'s Goals for ${managerGoals[0].review_cycle}:</strong><br><br>${managerGoalsList}<br><br>
          These are the strategic priorities your manager is focused on this year.`;
      }

      // Employee's own goals
      const goalsList = goals
        .map(
          (g: any, i: number) =>
            `<strong>${i + 1}. ${g.objective}</strong><br>
        ${g.description}<br>
        Strategy: ${g.strategy} | Your Rating: ${g.employee_rating}/5 | Manager Rating: ${g.manager_rating}/5 | Due: ${new Date(g.target_date).toLocaleDateString()}`
        )
        .join("<br><br>");

      return `<strong>Your Goals for ${review.review_cycle}:</strong><br><br>${goalsList}<br><br>
        Keep up the great work! Update your progress in the Goals section.`;
    }

    // Review questions
    if (q.includes("review") || q.includes("performance")) {
      return `<strong>Your Performance Review:</strong><br><br>
        <strong>Review Cycle:</strong> ${review.review_cycle}<br>
        <strong>Status:</strong> ${review.status}<br>
        <strong>Phase:</strong> ${review.phase}<br>
        <strong>Your Self-Rating:</strong> ${review.employee_rating}/5<br>
        <strong>Manager Rating:</strong> ${review.manager_rating}/5<br><br>
        <strong>Your Comments:</strong><br>${review.employee_comments}<br><br>
        <strong>Manager Comments:</strong><br>${review.manager_comments}<br><br>
        You're doing great! Keep building on your strengths.`;
    }

    if (q.includes("holiday") || q.includes("holidays")) {
      return `Here are the company holidays for 2025:<br><br>
        • New Year's Day - January 1<br>
        • Memorial Day - May 26<br>
        • Independence Day - July 4<br>
        • Labor Day - September 1<br>
        • Thanksgiving - November 27-28<br>
        • Christmas - December 25-26<br><br>
        All offices will be closed on these dates. These are paid holidays for full-time employees.`;
    }

    if (q.includes("hr contact") || q.includes("hr team")) {
      return `Your HR contacts are:<br><br>
        <strong>Primary HR Business Partner:</strong><br>
        Sarah Johnson - sarah.johnson@company.com<br><br>
        <strong>Benefits Team:</strong><br>
        benefits@company.com<br><br>
        <strong>Payroll Questions:</strong><br>
        payroll@company.com<br><br>
        You can also reach the HR team through the Help Center in Nestey or by calling (555) 123-4567.`;
    }

    // Default response
    return `Hi ${employee.first_name}! I'm here to help with your HR questions. I can assist with:<br><br>
      • Your personal info, manager, and compensation<br>
      • Time off balances and requests (you have ${timeOff.pto_balance} PTO days)<br>
      • Benefits information (Medical, Dental, Vision)<br>
      • Your goals and performance review<br>
      • Company policies and HR contacts<br><br>
      What would you like to know more about?`;
  }
</script>
